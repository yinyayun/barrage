define("dypassport/com/authorized-login",["jquery","dypassport/com/user-control","dypassport/com/user-view-util"],function(i,o,t){function n(o){var t="";try{t=i.i18n.prop(o)}catch(n){}return t}var e="passport_login_callback",a=window.$SYS||{},r=window.client_id||1,s=a.res_url||"",d=window.passport_host||"",c=s+"douyu/images/defaultAvatar.png?20180326",l={arr:a.pc_auth_port||[],host:d.substring(0,d.length-1).replace(/http(s?):\/\//gi,""),index:0,port:"",status:0};l.len=l.arr.length;var u={init:function(){l.status=0,this.getDoms(),this.getUserInfoFromClient()},destroy:function(){l.status=1},getDoms:function(){this.doms={qrcodeRightBox:i("#scancode-qrcode-right")}},authorizedTpl:function(i){var o=i.icon||c,t=i.nickname||"";return['<div class="authorized-login-box" id="js-authorized-box" style="display: none">','<div class="authorized-login-header">',n("编码.点击头像授权登录")||"点击头像授权登录","</div>",'<div class="authorized-login-userInfo">','<div class="authorized-login-userPic js-authorized-btn">','<img src="'+o+'" alt="" />',"</div>",'<div class="authorized-login-userName ellipsis" title="'+t+'">'+t+"</div>","</div>",'<div class="authorized-login-tip">','<span class="authorized-login-icon"></span>','<span class="authorized-login-text">',n("编码.PC客户端在线")||"PC客户端在线","</span>","</div>","</div>"].join("")},authorizedFailTpl:function(){return'<div class="scan-phonetip" id="js-scan-phonetip" style="display: none"></div>'},fadeOutCahnge:function(o,t,n,e){i(n).fadeOut("normal",function(){i(o).html(e),i(t).fadeIn()})},pcNotLoginView:function(){var i=this.doms,o=this.authorizedFailTpl();this.fadeOutCahnge(i.qrcodeRightBox,"#js-scan-phonetip","#js-authorized-box",o)},getUserInfoFromClient:function(){if(!l.status){var t=this,n=t.doms,e=function(o){if(l.port=l.arr[l.index],0===+o.error&&o.data&&o.data.is_login){var e=t.authorizedTpl(o.data);t.fadeOutCahnge(n.qrcodeRightBox,"#js-authorized-box","#js-scan-phonetip",e),t.bindEvent()}else t.pcNotLoginView(),o.msg&&i.dialog.tips_black(o.msg)},r=function(){l.index>=l.len-1||(l.index++,t.getUserInfoFromClient())},s="//local."+l.host+":"+l.arr[l.index]+"/pcclient/getUserInfo",d={lang:a.lang||"cn"};o.API.getUserInfo(s,d,e,r)}},getPcCodeFromClient:function(){var t=this,e=(t.doms,n("编码.授权登录失败")||"授权登录失败"),s=function(o){0===+o.error&&o.data&&o.data.is_login?t.userClientCodeToLogin():(t.pcNotLoginView(),i.dialog.tips_black(e))},d=function(){t.pcNotLoginView(),i.dialog.tips_black(e)},c="//local."+l.host+":"+l.arr[l.index]+"/pcclient/getCode",u={client_id:r,cookie_pre:a.cookie_pre||"",lang:a.lang||"cn"};o.API.getPcCode(c,u,s,d)},userClientCodeToLogin:function(){var t=this,n=function(o){0===+o.error&&"object"==typeof o.data?t.userCodeExchangeToken(o.data.url):i.dialog.tips_black(o.msg)},e=function(){},a={time:(new Date).getTime(),client_id:window.client_id||1};o.API.useClentCodeToLogin(a,n,e)},userCodeExchangeToken:function(a){if(a){var s=function(o){if(0!==o.error)return void i.dialog.tips_black(o.msg);var n=t.getLocationParam(e);if(n&&window.parent&&window.parent[n]){var a=window.parent[n];if(a&&i.isFunction(a))return o.client_id=r,o.passport_callback=window.passport_callback||"",void a.call(window.parent,o)}var s=window.passport_callback;setTimeout(function(){s?location.replace(s):location.reload()})},d=function(){i.dialog.tips_black(n("编码.登录过程中发生错误，请稍候再试")||"登录过程中发生错误，请稍候再试")};o.API.subSiteLogin(a,{},s,d)}},bindEvent:function(){var i=this,o=i.doms;o.qrcodeRightBox.off().on("click.pcclient.toLogin",".js-authorized-btn",function(){i.getPcCodeFromClient()})}};return{init:function(){u.init()},destroy:function(){u.destroy()}}});